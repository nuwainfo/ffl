<!DOCTYPE html>
<!--
FastFileLink CLI at https://github.com/nuwainfo/ffl
Licensed under Apache-2.0 license.
-->
<html lang="en">
<head>
    <!--Workaround for fixing Django CMS issues-->
    <meta name="comment" content="The template was modified by Nuwainfo.com"/>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <meta name="description" content="None"/>
    <meta name="author" content=""/>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""/>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&amp;display=swap"
          rel="stylesheet"/>
    <title>FastFileLink</title>
    <!-- Bootstrap core CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <!-- Additional CSS Files -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
          integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous"/>

    <!-- Custom CSS Files -->
    <link rel="stylesheet" href="{{ STATIC_SERVER }}/static/client/theme.css">

    <!-- To avoid favicon.ico not found error -->
    <link rel="icon" href="{{ STATIC_SERVER }}/static/client/Logo.png" type="image/x-icon">
        
    <!-- InApp Browser Detection Warning Styles -->
    <link rel="stylesheet" href="{{ STATIC_SERVER }}/static/css/InAppGuard.css">
    
    <!-- DownloadManager Styles -->
    <link rel="stylesheet" href="{{ STATIC_SERVER }}/static/css/DownloadUI.css">

    <!-- E2EE (End-to-End Encryption) UI Styles -->
    <link rel="stylesheet" href="{{ STATIC_SERVER }}/static/css/E2EE.css">

    <!-- Preview Components (File hint + ZIP preview) -->
    <link rel="stylesheet" href="{{ STATIC_SERVER }}/static/css/Preview.css">

    <!-- i18next internationalization scripts -->
    <script src="https://unpkg.com/i18next@25.5.2/dist/umd/i18next.js"></script>
    <script src="https://unpkg.com/i18next-http-backend@3.0.2/i18nextHttpBackend.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector@8.2.0/dist/umd/i18nextBrowserLanguageDetector.min.js"></script>
    <script src="https://unpkg.com/jquery-i18next@1.2.1/dist/umd/jquery-i18next.min.js"></script>
    <script src="{{ STATIC_SERVER }}/static/js/FFLI18n.js"></script>
</head>
    <body>
        <div id="pricing" class="main-banner wow fadeIn pricing-tables">
            <div class="container">
                <div class="right-image wow fadeInRight row">
                    <div class="col-lg-8 offset-lg-2">
                        <div class="section-heading">
                            <h4>
                                <span data-i18n="Download:title">Downloading</span>
                                <em><span data-i18n="Download:file">File</span></em>
                                <i id="file-info-icon" class="fas fa-info-circle"
                                   style="margin-left: 8px; margin-right: 8px; color: #007bff; cursor: help; font-size: 0.8em;"></i>
                                <i id="file-preview-btn" class="fas fa-eye"
                                   style="display: none; margin-right: 8px; color: #28a745; cursor: pointer; font-size: 0.8em;"
                                   title="Preview contents"></i>
                                <span data-i18n="Download:ellipsis">...</span>
                            </h4>
                            <!-- Inline file info hint (auto fade-out) - starts hidden but occupies space -->
                            <div id="file-intro-inline-hint" class="file-intro-inline-hint">
                                <div id="file-intro-inline-text" class="file-intro-inline-text"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 offset-lg-4">
                        <!-- InApp Browser Warning -->
                        <div id="inapp-warning" class="inapp-warning">
                            <i class="fas fa-exclamation-triangle warning-icon"></i>
                            <div class="warning-title" data-i18n="Download:warning.title">Download may not work in this browser</div>
                            <div id="warning-text" class="warning-text" data-i18n="Download:warning.text">
                                To download this file, please open this link in your browser.
                            </div>
                            <a id="open-browser-btn" href="#" class="open-browser-btn">
                                <i class="fas fa-download"></i> <span data-i18n="Download:warning.button">Download in Browser</span>
                            </a>
                            <a id="copy-link-btn" href="#" class="open-browser-btn" style="margin-top: 8px;">
                                <i class="fas fa-copy"></i> <span data-i18n="Download:warning.copyButton">Copy Link</span>
                            </a>
                        </div>

                        <div class="pricing-item-pro" style="background-color: rgba(255, 255, 255, 0.5);">
                            <!-- Status Display with Download Button -->
                            <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 15px;">
                                <div id="statusText" style="text-align: center; font-weight: bold;" data-i18n="Download:client.status.establishing">Establishing connection...</div>
                                <button id="play-download-btn" class="play-download-btn" style="display: none;" title="Start download">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>

                            <!-- Progress Bar -->
                            <div class="progress" style="margin-bottom: 20px;">
                                <progress id="downloadProgress" value="0" max="100" style="width: 100%;"></progress>
                            </div>
                            
                            <!-- Connection Type Display -->
                            <div id="connectionType" style="text-align: center; color: #007bff; font-size: 14px; margin-bottom: 10px;"></div>

                            <div class="border-button">
                                <h6 id="download-message" data-i18n="Download:client.download.startShortly">Your download will start shortly.</h6>
                                <div id="status-details" style="font-size: 14px; color: #666; margin-top: 5px;"></div>
                            </div>

                            <!-- Retry functionality (hidden by default) -->
                            <div class="delayed-show" style="display: none;">
                                <a id="retry-link" href="#" class="btn btn-primary" data-i18n="Download:client.retry.button">Retry Download</a>
                                <div id="retry-confirmation" class="retry-confirmation" style="display: none;">
                                    <div class="retry-confirmation-title" data-i18n="Download:client.retry.confirmationTitle">Open download in new tab?</div>
                                    <a id="confirm-retry" href="#" target="_blank" class="confirm-retry-btn" data-i18n="Download:retry.confirmButton">Yes, Open New Tab</a>
                                    <button id="cancel-retry" class="cancel-retry-btn" data-i18n="Download:retry.cancelButton">Cancel</button>
                                </div>
                            </div>

                            <!-- E2EE Retry Blocked Warning -->
                            <div id="e2ee-retry-blocked" class="e2ee-retry-blocked">
                                <div class="e2ee-retry-blocked-icon">üîí</div>
                                <div class="e2ee-retry-blocked-title" data-i18n="Download:e2ee.retryBlocked.title">
                                    Encrypted Download Requires This Page
                                </div>
                                <div class="e2ee-retry-blocked-message" data-i18n="Download:e2ee.retryBlocked.message">
                                    Direct browser downloads cannot decrypt this file. The decryption must happen in this page with your encryption key.
                                </div>
                                <div class="e2ee-retry-blocked-solutions">
                                    <div class="e2ee-retry-blocked-subtitle" data-i18n="Download:e2ee.retryBlocked.solutionsTitle">
                                        Try these solutions:
                                    </div>
                                    <ul class="e2ee-retry-blocked-list">
                                        <li data-i18n="[html]Download:e2ee.retryBlocked.solution1">
                                            <strong>Different Browser:</strong> Try Chrome, Edge, or Brave for better compatibility
                                        </li>
                                        <li>
                                            <strong data-i18n="Download:e2ee.retryBlocked.solution2Title">Command Line Tool:</strong>
                                            <span data-i18n="Download:e2ee.retryBlocked.solution2Text">Use the</span>
                                            <a href="https://github.com/nuwainfo/ffl" target="_blank" rel="noopener" class="e2ee-cli-link">FastFileLink CLI</a>
                                            <span data-i18n="Download:e2ee.retryBlocked.solution2Stable">for stable downloads of large encrypted files</span>
                                        </li>
                                        <li data-i18n="[html]Download:e2ee.retryBlocked.solution3">
                                            <strong>Wait:</strong> The download may still be progressing in the background
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Close tab option (shown after opening new tab) -->
                            <div id="close-tab-wrap" class="close-tab-wrap" style="display: none; text-align: center; margin-top: 10px;">
                                <a id="close-this-tab" href="#" class="btn btn-secondary" style="padding: 8px 16px; border-radius: 20px;" data-i18n="Download:closeTab">Close this tab</a>
                            </div>

                            <!-- Fallback Download Button - Hidden -->
                            <div id="fallback-container" style="display: none;">
                                <!-- Visible button for manual user clicks - remains functional -->
                                <div class="border-button">
                                    <a id="manual-download-link" href="/uid=****/download" data-i18n="Download:client.manualDownload">Download</a>
                                </div>
                            </div>

                            <!-- Hidden file metadata -->
                            <p id="fileName" style="display:none;">{{ fileName }}</p>
                            <p id="fileSize" style="display:none;">{{ fileSize }}</p>
                            
                            <!-- Always visible footer message -->
                            <div class="border-button">
                                <p style="font-size: 14px; margin-top: 10px; line-height: 1.2;">
                                    {{ FOOTER_MESSAGE_HTML }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Info Hint (positioned near info icon) -->
        <div id="file-intro-hint" class="file-intro-hint">
            <div class="file-intro-hint-header">
                <i class="fas fa-file-archive file-intro-hint-icon" id="file-intro-icon"></i>
                <div class="file-intro-hint-title">
                    <div class="file-intro-hint-filename" id="file-intro-filename" data-i18n="Download:zipPreview.file">File</div>
                    <div class="file-intro-hint-meta">
                        <div class="file-intro-hint-meta-item">
                            <i class="fas fa-hdd"></i>
                            <span id="file-intro-filesize" data-i18n="Download:zipPreview.loading">Loading...</span>
                        </div>
                        <div class="file-intro-hint-meta-item">
                            <i class="fas fa-file"></i>
                            <span id="file-intro-filecount" data-i18n="Download:zipPreview.loading">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="file-intro-hint-content">
                <div class="file-intro-hint-stats">
                    <div class="file-intro-hint-stat">
                        <div class="file-intro-hint-stat-value" id="file-intro-stat-images">0</div>
                        <div class="file-intro-hint-stat-label" data-i18n="Download:zipPreview.hint.images">Images</div>
                    </div>
                    <div class="file-intro-hint-stat">
                        <div class="file-intro-hint-stat-value" id="file-intro-stat-others">0</div>
                        <div class="file-intro-hint-stat-label" data-i18n="Download:zipPreview.hint.otherFiles">Other Files</div>
                    </div>
                </div>
            </div>
            <button id="file-intro-preview-btn" class="file-intro-hint-preview">
                <i class="fas fa-eye"></i>
                <span data-i18n="Download:zipPreview.button">Preview Contents</span>
            </button>
        </div>

        <!-- No-JavaScript Fallback -->
        <noscript>
            <style>
                #fallback-container {
                    display: block !important;
                }
            </style>
        </noscript>
        <footer id="newsletter">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="copyright-text">
                            <p>
                                <span>{{ COPYRIGHT }}</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
        <!-- Scripts -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
                integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
                crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js" 
                integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" 
                crossorigin="anonymous"></script>
        <!--<script src="https://cdn.jsdelivr.net/npm/streamsaver@2.0.6/StreamSaver.min.js"></script>-->
        <!-- Support blob for debugging -->
        <script src="{{ STATIC_SERVER }}/static/js/StreamSaver.js?blob={{ STREAMSAVER_BLOB }}"></script>

        <!-- Shared Logging -->
        <script>
            // Debug configuration and logging setup (must be first)
            const DEBUG = false; // Set to true to enable detailed logging
            const SERVER_DEBUG = false; // Server-injected: enables mobile debugging via JS_LOG_TO_SERVER_DEBUG + ?debug=server

            // Generate unique session ID for this client session (for multi-user debug logging)
            const generateSessionId = () => {
                if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                    return crypto.randomUUID();
                } else {
                    // Fallback for older browsers
                    return 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                }
            };
            const DEBUG_SESSION_ID = SERVER_DEBUG ? generateSessionId() : null;

            // Function to send logs to server for mobile debugging
            const sendLogToServer = (category, message, timestamp) => {
                try {
                    fetch('/debug/log', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            category: category,
                            message: message,
                            timestamp: timestamp,
                            sessionId: DEBUG_SESSION_ID
                        })
                    }).catch(err => {
                        // Silently ignore server logging errors to avoid infinite loops
                        if (DEBUG) console.warn('Failed to send log to server:', err);
                    });
                } catch (err) {
                    // Silently ignore errors
                    if (DEBUG) console.warn('Error in sendLogToServer:', err);
                }
            };

            // Global logger function (available to all scripts)
            const log = (category, message, ...args) => {
                // First determine whether to output to console/server (preserve original switch semantics)
                let printToConsole = !!DEBUG;
                let sendToServer = !!SERVER_DEBUG;

                // Check if the last parameter is an "options" object
                if (args.length > 0) {
                    const last = args[args.length - 1];

                    if (typeof last === 'boolean') {
                        // Last param is boolean: controls whether to send to server
                        sendToServer = sendToServer && last;   // false => disable sending; true => maintain original gating
                        args.pop(); // Remove flag from args to avoid it being included in the message
                    } else if (
                        last &&
                        typeof last === 'object' &&
                        !Array.isArray(last) &&
                        (Object.prototype.hasOwnProperty.call(last, 'server') ||
                         Object.prototype.hasOwnProperty.call(last, 'console'))
                    ) {
                        // Last param is options object: { server?: boolean, console?: boolean }
                        if ('server' in last)  sendToServer   = sendToServer   && !!last.server;
                        if ('console' in last) printToConsole = printToConsole && !!last.console;
                        args.pop(); // Remove options object from args
                    }
                }

                // Early return if nothing should be logged
                if (!printToConsole && !sendToServer) {
                    return;
                }
                
                const timestamp = new Date().toISOString(); 
                const prefix = `[${timestamp}] [${category}]`;
                const fullMessage = args.length > 0 ? `${message} ${JSON.stringify(args)}` : message;

                // Output to console if enabled
                if (printToConsole) {
                    if (args.length > 0) {
                        console.log(`${prefix} ${message}`, ...args);
                    } else {
                        console.log(`${prefix} ${message}`);
                    }
                }

                // Send to server if enabled
                if (sendToServer) {
                    sendLogToServer(category, fullMessage, timestamp);
                }
            };
        </script>
        
        <!-- Initialize i18n using common initialization -->
        <script>
            // Initialize i18n system with log function and Download namespace
            initializeI18n({
                log: log,
				getCurrentLanguageFunc: function() { null },
                localesPath: '{{ STATIC_SERVER }}/static/locales',
                ns: ['Download']  // Load Download namespace for this page
            });
        </script>
                
        <!-- Include InApp Guard -->
        <script src="{{ STATIC_SERVER }}/static/js/InAppGuard.js"></script>
        <script>          
           // Global variable to track if we should skip WebRTC
            let SKIP_WEBRTC_DUE_TO_RESTRICTION = false;

            // Initialize InApp Guard using centralized function
            SKIP_WEBRTC_DUE_TO_RESTRICTION = InAppGuard.initInAppGuardUI({
                log: log,
                skipVariableName: 'SKIP_WEBRTC_DUE_TO_RESTRICTION'
            });            
        </script>
        
        <!-- DownloadManager integration -->
        <script src="{{ STATIC_SERVER }}/static/js/DownloadManager.js"></script>

        <!-- E2E Encryption Support -->
        <script src="{{ STATIC_SERVER }}/static/js/E2EE.js"></script>

        <!-- ZIP Preview Extractor (load before WebRTC to ensure availability) -->
        <script src="{{ STATIC_SERVER }}/static/js/ZipPreviewExtractor.js"></script>

        <!-- ZIP Preview UI Integration (load before WebRTC to ensure availability) -->
        <script src="{{ STATIC_SERVER }}/static/js/PreviewUI.js"></script>

        <!-- WebRTC Utilities (Writers, Utilities, Debug Config, Download Managers) -->
        <script src="./static/js/WebRTC.js"></script>

        <!-- WebRTC and Download Script -->
        <script>
            const DISABLE_WEBRTC = false;

            // Flag to prevent multiple initializations
            let downloadInitialized = false;
            // Timer reference for fallback mechanism
            let startWebRTCTimer = null;

            // Wait for i18n to be ready before starting
            function startWebRTCDownload() {
                // Prevent duplicate execution
                if (downloadInitialized)
                    return;

                downloadInitialized = true;

                // Cancel fallback timer if it's still pending
                if (startWebRTCTimer) {
                    clearTimeout(startWebRTCTimer);
                    startWebRTCTimer = null;
                }

                // Get file metadata from DOM
                const fileName = document.getElementById('fileName')?.textContent || 'download.bin';
                const fileSize = parseInt(document.getElementById('fileSize')?.textContent || '0', 10);

                // Create WebRTCManager instance
                const webrtcManager = new WebRTCManager({
                    // UID - Server.py replaces 'uid=****' with actual UID
                    uid: 'uid=****',

                    // Flags
                    disableWebRTC: DISABLE_WEBRTC,
                    debug: DEBUG,

                    // File metadata
                    fileName: fileName,
                    fileSize: fileSize,

                    // Functions
                    log: log,
                    t: t,

                    // DOM Elements
                    progressBar: document.getElementById('downloadProgress'),
                    statusText: document.getElementById('statusText'),
                    connectionType: document.getElementById('connectionType'),
                    downloadMessage: document.getElementById('download-message'),
                    downloadButton: document.getElementById('play-download-btn')
                });

                // Start the download process
                webrtcManager.start();
            } // End of startWebRTCDownload function
            
            // Start when i18n is ready (or immediately if i18n is already initialized).
            window.runAfterI18nReady(startWebRTCDownload);

            // Fallback: if i18nReady doesn't fire within 2 seconds, proceed anyway
            startWebRTCTimer = setTimeout(() => {
                startWebRTCDownload();
            }, 2000);
        </script>
        
        <script>
            // Status polling for server-side error notifications
            let statusPoller = null;
            let consecutiveStatusFailures = 0;
            const MAX_STATUS_FAILURES = 2;
            const STATUS_POLLING_SECONDS = 2;

            function startStatusPolling() {
                // Poll every 2 seconds
                statusPoller = setInterval(async () => {
                    try {
                        const response = await fetch('/status');
                        if (!response.ok) {
                            consecutiveStatusFailures++;
                            log("Status", `Status request failed (${response.status}): ${consecutiveStatusFailures}/${MAX_STATUS_FAILURES}`);

                            // Stop polling after consecutive failures
                            if (consecutiveStatusFailures >= MAX_STATUS_FAILURES) {
                                log("Status", `Stopping status polling after ${MAX_STATUS_FAILURES} consecutive failures`);
                                stopStatusPolling();
                            }
                            return;
                        }

                        // Reset failure counter on success
                        consecutiveStatusFailures = 0;

                        const status = await response.json();
                        if (status.error) {
                            // Get message based on error type (i18n support)
                            const message = getErrorMessage(status.error);

                            // Show error notification
                            showErrorNotification(message);

                            // Stop polling after error is received
                            stopStatusPolling();

                            // Log error details for debugging
                            if (status.error.detail) {
                                log("Status", `Error detail: ${status.error.detail}`);
                            }
                        }
                    } catch (e) {
                        // Count network errors as failures
                        consecutiveStatusFailures++;
                        console.debug(`Status polling error (${consecutiveStatusFailures}/${MAX_STATUS_FAILURES}):`, e);

                        // Stop polling after consecutive network errors
                        if (consecutiveStatusFailures >= MAX_STATUS_FAILURES) {
                            log("Status", `Stopping status polling after ${MAX_STATUS_FAILURES} consecutive network errors`);
                            stopStatusPolling();
                        }
                    }
                }, STATUS_POLLING_SECONDS * 1000);
            }

            function stopStatusPolling() {
                if (statusPoller) {
                    clearInterval(statusPoller);
                    statusPoller = null;
                }
            }

            function getErrorMessage(error) {
                // Map error types to i18n keys with default fallback messages
                const errorDefaults = {
                    'folder_changed': 'The shared folder contents changed during transfer. The file owner needs to reshare the folder.',
                    // Add more error types here as needed
                };

                // Use i18next for known error types
                if (error.type && errorDefaults[error.type]) {
                    // Use window.t() which safely handles i18next initialization
                    return window.t(`errors.${error.type}`, errorDefaults[error.type]);
                } else {
                    // Unknown error type - use server's detail message or generic fallback
                    return error.detail || window.t('Download:errors.unknown', 'An error occurred during transfer.');
                }
            }

            function showErrorNotification(message) {
                // Create notification element if it doesn't exist
                let notification = document.getElementById('error-notification');
                if (!notification) {
                    notification = document.createElement('div');
                    notification.id = 'error-notification';
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        background-color: #dc3545;
                        color: white;
                        padding: 15px 25px;
                        border-radius: 5px;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
                        z-index: 10000;
                        max-width: 600px;
                        text-align: center;
                        font-size: 16px;
                        font-weight: 500;
                    `;
                    document.body.appendChild(notification);
                }

                // Set message
                notification.textContent = `‚ö†Ô∏è ${message}`;
                notification.style.display = 'block';

                // Also log to console
                log("Error", message);
            }

            // Start status polling when page loads
            startStatusPolling();

            // Stop polling when page is closed
            window.addEventListener('beforeunload', stopStatusPolling);

        </script>

    </body>
</html>
