name: Install script e2e test
on:
  push:
  workflow_dispatch:

env:
  FFL_VERSION: v3.7.4
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        variant: [native, manylinux, com]
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y curl ca-certificates unzip libarchive-tools
      - name: Run installer (local)
        env:
          FFL_VARIANT: ${{ matrix.variant }}
        run: |
          set -eux
          bash ./install.sh
      - name: Verify
        run: |
          set -eux
          which ffl || true
          ffl --version || true

  macos:
    runs-on: macos-latest
    strategy:
      matrix:
        variant: [native, com]
    steps:
      - uses: actions/checkout@v4
      - name: Run installer (local)
        env:
          FFL_VARIANT: ${{ matrix.variant }}
        run: |
          set -eux
          bash ./install.sh
      - name: Verify
        run: |
          set -eux
          ffl --version || true

  windows:
    runs-on: windows-latest
    strategy:
      matrix:
        variant: [native, com]
    steps:
      - uses: actions/checkout@v4
      - name: Run installer (local)
        shell: pwsh
        env:
          FFL_VARIANT: ${{ matrix.variant }}
        run: |
          $ErrorActionPreference = "Stop"
          pwsh -File ./install.ps1
      - name: Verify
        shell: pwsh
        run: |
          $dest = Join-Path $env:LOCALAPPDATA "Programs\ffl"
          Write-Host "Dest: $dest"
          if ("${{ matrix.variant }}" -eq "com") {
            if (Test-Path (Join-Path $dest "ffl.com")) {
              & (Join-Path $dest "ffl.com") --version
            } else {
              throw "ffl.com not found under $dest"
            }
          } else {
            if (Test-Path (Join-Path $dest "ffl.exe")) {
              & (Join-Path $dest "ffl.exe") --version
            } else {
              throw "ffl.exe not found under $dest"
            }
          }
