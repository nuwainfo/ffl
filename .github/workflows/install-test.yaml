name: Install script e2e test
permissions:
  contents: read
on:
  push:
  workflow_dispatch:

env:
  FFL_VERSION: "v3.7.6"
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  linux:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: native
          - variant: manylinux
          - variant: com
            ape: ffl
          - variant: com
            ape: fflo
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y curl ca-certificates unzip libarchive-tools
      - name: Run installer (local)
        env:
          FFL_VARIANT: ${{ matrix.variant }}
          FFL_APE: ${{ matrix.ape }}
        run: |
          set -eux
          bash ./dist/install.sh
      - name: Verify
        env:
          FFL_VARIANT: ${{ matrix.variant }}
          FFL_APE: ${{ matrix.ape }}
        run: |
          set -eux
          which ffl || true
          if [ "${FFL_VARIANT}" = "com" ] && [ -n "${FFL_APE:-}" ]; then
            if command -v "${FFL_APE}.com" >/dev/null 2>&1; then
              "${FFL_APE}.com" --version || true
            else
              # if installer created `ffl` symlink, still allow `ffl --version`
              ffl --version || true
            fi
          else
            ffl --version || true
          fi

  macos:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: native
          - variant: com
            ape: ffl
          - variant: com
            ape: fflo
    steps:
      - uses: actions/checkout@v4
      - name: Run installer (local)
        env:
          FFL_VARIANT: ${{ matrix.variant }}
          FFL_APE: ${{ matrix.ape }}
        run: |
          set -eux
          bash ./dist/install.sh
      - name: Verify
        env:
          FFL_VARIANT: ${{ matrix.variant }}
          FFL_APE: ${{ matrix.ape }}
        run: |
          set -eux
          if [ "${FFL_VARIANT}" = "com" ] && [ -n "${FFL_APE:-}" ]; then
            if command -v "${FFL_APE}.com" >/dev/null 2>&1; then
              "${FFL_APE}.com" --version || true
            else
              ffl --version || true
            fi
          else
            ffl --version || true
          fi

  windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: native
          - variant: com
            ape: ffl
          - variant: com
            ape: fflo
    steps:
      - uses: actions/checkout@v4
      - name: Run installer (local)
        shell: pwsh
        env:
          FFL_VARIANT: ${{ matrix.variant }}
          FFL_APE: ${{ matrix.ape }}
        run: |
          $ErrorActionPreference = "Stop"
          pwsh -File ./dist/install.ps1
      - name: Verify
        shell: pwsh
        env:
          FFL_VARIANT: ${{ matrix.variant }}
          FFL_APE: ${{ matrix.ape }}
        run: |
          $dest = Join-Path $env:LOCALAPPDATA "Programs\ffl"
          Write-Host "Dest: $dest"
          if ($env:FFL_VARIANT -eq "com") {
            $ape = $env:FFL_APE
            if ([string]::IsNullOrWhiteSpace($ape)) { $ape = "ffl" }
            $comPath = Join-Path $dest ("{0}.com" -f $ape)
            if (Test-Path $comPath) {
              & $comPath --version
            } else {
              throw ("{0} not found under {1}" -f (Split-Path $comPath -Leaf), $dest)
            }
          } else {
            $exePath = Join-Path $dest "ffl.exe"
            if (Test-Path $exePath) {
              & $exePath --version
            } else {
              throw "ffl.exe not found under $dest"
            }
          }
