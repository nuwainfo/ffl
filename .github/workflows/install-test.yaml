name: Install script e2e test
permissions:
  contents: read
on:
  push:
  workflow_dispatch:

env:
  FFL_VERSION: "v3.8.3"
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  linux:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: native
          - variant: manylinux
          - variant: com
            ape: ffl
          - variant: com
            ape: fflo
          - variant: com
            ape: fflo
            target: 1
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y curl ca-certificates unzip libarchive-tools
      - name: Run installer (local)
        env:
          FFL_VARIANT: ${{ matrix.variant }}
          FFL_APE: ${{ matrix.ape }}
          FFL_TARGET: ${{ matrix.target && '/tmp/ffl_target_test' || '' }}
        run: |
          set -eux
          bash ./dist/install.sh
      - name: Verify
        env:
          FFL_VARIANT: ${{ matrix.variant }}
          FFL_APE: ${{ matrix.ape }}
          FFL_TARGET: ${{ matrix.target && '/tmp/ffl_target_test' || '' }}
        run: |
          set -eux
          if [ -n "${FFL_TARGET:-}" ]; then
            "${FFL_TARGET}" --version || true
            exit 0
          fi
          which ffl || true
          if [ "${FFL_VARIANT}" = "com" ] && [ -n "${FFL_APE:-}" ]; then
            if command -v "${FFL_APE}.com" >/dev/null 2>&1; then
              "${FFL_APE}.com" --version || true
            else
              # if installer created `ffl` symlink, still allow `ffl --version`
              ffl --version || true
            fi
          else
            ffl --version || true
          fi

  macos:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: native
          - variant: com
            ape: ffl
          - variant: com
            ape: fflo
          - variant: com
            ape: fflo
            target: 1
    steps:
      - uses: actions/checkout@v4
      - name: Run installer (local)
        env:
          FFL_VARIANT: ${{ matrix.variant }}
          FFL_APE: ${{ matrix.ape }}
          FFL_TARGET: ${{ matrix.target && '/tmp/ffl_target_test' || '' }}
        run: |
          set -eux
          bash ./dist/install.sh
      - name: Verify
        env:
          FFL_VARIANT: ${{ matrix.variant }}
          FFL_APE: ${{ matrix.ape }}
          FFL_TARGET: ${{ matrix.target && '/tmp/ffl_target_test' || '' }}
        run: |
          set -eux
          if [ -n "${FFL_TARGET:-}" ]; then
            "${FFL_TARGET}" --version || true
            exit 0
          fi
          if [ "${FFL_VARIANT}" = "com" ] && [ -n "${FFL_APE:-}" ]; then
            if command -v "${FFL_APE}.com" >/dev/null 2>&1; then
              "${FFL_APE}.com" --version || true
            else
              ffl --version || true
            fi
          else
            ffl --version || true
          fi

  windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: native
          - variant: com
            ape: ffl
          - variant: com
            ape: fflo
          - variant: com
            ape: fflo
            target: 1
    steps:
      - uses: actions/checkout@v4
      - name: Run installer (local)
        shell: pwsh
        env:
          FFL_VARIANT: ${{ matrix.variant }}
          FFL_APE: ${{ matrix.ape }}
          FFL_TARGET: ${{ matrix.target && format('{0}\ffl_target_test.com', env.TEMP) || '' }}
        run: |
          $ErrorActionPreference = "Stop"
          pwsh -File ./dist/install.ps1
      - name: Verify
        shell: pwsh
        env:
          FFL_VARIANT: ${{ matrix.variant }}
          FFL_APE: ${{ matrix.ape }}
          FFL_TARGET: ${{ matrix.target && format('{0}\ffl_target_test.com', env.TEMP) || '' }}
        run: |
          $ErrorActionPreference = "Stop"
          if (-not [string]::IsNullOrWhiteSpace($env:FFL_TARGET)) {
            if (Test-Path $env:FFL_TARGET) {
              & $env:FFL_TARGET --version
            } else {
              throw "FFL_TARGET not found: $($env:FFL_TARGET)"
            }
            exit 0
          }

          $dest = Join-Path $env:LOCALAPPDATA "Programs\ffl"
          Write-Host "Dest: $dest"
          if ("${{ matrix.variant }}" -eq "com") {
            if (Test-Path (Join-Path $dest "ffl.com")) {
              & (Join-Path $dest "ffl.com") --version
            } else {
              throw "ffl.com not found under $dest"
            }
          } else {
            if (Test-Path (Join-Path $dest "ffl.exe")) {
              & (Join-Path $dest "ffl.exe") --version
            } else {
              throw "ffl.exe not found under $dest"
            }
          }
